#!/bin/bash
# ===================================================================================
# ü§ñ start_robot.sh - Robot System Launcher (Wrapper ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Launch File ‡πÉ‡∏´‡∏°‡πà)
# ===================================================================================
# ‡πÑ‡∏ü‡∏•‡πå‡∏ô‡∏µ‡πâ‡πÄ‡∏õ‡πá‡∏ô Wrapper ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡πÉ‡∏ä‡πâ robot_system.launch.py
# ‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏ú‡πà‡∏≤‡∏ô Terminal ‡∏´‡∏£‡∏∑‡∏≠‡∏ú‡πà‡∏≤‡∏ô HardwareService ‡πÑ‡∏î‡πâ
#
# ‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô:
#   ./start_robot.sh         # ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏£‡∏∞‡∏ö‡∏ö‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
#   Ctrl+C                   # ‡∏´‡∏¢‡∏∏‡∏î‡∏£‡∏∞‡∏ö‡∏ö‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î (Clean Shutdown)
# ===================================================================================

BLUE='\033[0;34m'
GREEN='\033[0;32m'
RED='\033[0;31m'
NC='\033[0m'

echo -e "${BLUE}ü§ñ Starting Full Robot System...${NC}"

# =================================================================================
# 1. Environment Setup
# =================================================================================
source /opt/ros/humble/setup.bash
source /home/robot22/microros_ws/install/setup.bash
source /home/robot22/ros2robot/install/setup.bash

# ‡∏Å‡∏≥‡∏´‡∏ô‡∏î Path (‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏Å‡πà‡∏≠‡∏ô‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô)
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
BACKEND_ROOT="$(dirname "$SCRIPT_DIR")"

# =================================================================================
# 2. Cleanup ‡∏Ñ‡πâ‡∏≤‡∏á (‡∏Å‡∏±‡∏ô‡∏Å‡∏£‡∏ì‡∏µ process ‡πÄ‡∏Å‡πà‡∏≤‡πÑ‡∏°‡πà‡∏¢‡∏≠‡∏°‡∏ï‡∏≤‡∏¢)
# =================================================================================
echo -e "${GREEN}üßπ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏•‡πâ‡∏≤‡∏á process ‡πÄ‡∏Å‡πà‡∏≤‡∏ó‡∏µ‡πà‡∏≠‡∏≤‡∏à‡∏Ñ‡πâ‡∏≤‡∏á‡∏≠‡∏¢‡∏π‡πà...${NC}"
# Kill existing launch processes first to prevent port conflict
pkill -f "robot_system.launch.py" 2>/dev/null
sleep 2
pkill -f "micro_ros_agent" 2>/dev/null
pkill -f "ros2_bridge.py" 2>/dev/null
pkill -f "qos_relay_node.py" 2>/dev/null
pkill -f "scan_relay.py" 2>/dev/null
sleep 1

# =================================================================================
# 2.5 Reset ESP32/Teensy (‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö‡πÉ‡∏´‡πâ‡∏°‡∏±‡∏ô reconnect ‡∏Å‡∏±‡∏ö Micro-ROS Agent)
# =================================================================================
# echo -e "${GREEN}üîÑ ‡∏Å‡∏≥‡∏•‡∏±‡∏á Reset ESP32/Teensy...${NC}"
# ESP32_RESET_SCRIPT="$BACKEND_ROOT/core/hardware/esp32_reset.py"
# if [ -f "$ESP32_RESET_SCRIPT" ]; then
#     python3 "$ESP32_RESET_SCRIPT" /dev/ttyACM0
# else
#     echo -e "${RED}‚ö†Ô∏è ‡πÑ‡∏°‡πà‡∏û‡∏ö esp32_reset.py, ‡πÉ‡∏ä‡πâ sleep ‡πÅ‡∏ó‡∏ô...${NC}"
#     sleep 2
# fi
# =================================================================================
# 3. ‡∏Å‡∏≥‡∏´‡∏ô‡∏î Launch File Path
# =================================================================================
LAUNCH_FILE="$BACKEND_ROOT/core/hardware/robot_system.launch.py"

# =================================================================================
# 4. ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÑ‡∏ü‡∏•‡πå Launch
# =================================================================================
if [ ! -f "$LAUNCH_FILE" ]; then
    echo -e "${RED}‚ùå ‡πÑ‡∏°‡πà‡∏û‡∏ö‡πÑ‡∏ü‡∏•‡πå Launch: $LAUNCH_FILE${NC}"
    exit 1
fi

# =================================================================================
# 5. ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏£‡∏∞‡∏ö‡∏ö
# =================================================================================
echo -e "${GREEN}üöÄ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏õ‡∏¥‡∏î Robot System Launch...${NC}"
echo -e "   Launch File: $LAUNCH_FILE"

# ros2 launch ‡∏à‡∏∞‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£ lifecycle ‡∏Ç‡∏≠‡∏á‡∏ó‡∏∏‡∏Å node ‡πÉ‡∏´‡πâ
# ‡πÄ‡∏°‡∏∑‡πà‡∏≠ script ‡∏ô‡∏µ‡πâ‡∏ñ‡∏π‡∏Å kill ‡∏´‡∏£‡∏∑‡∏≠ Ctrl+C, ros2 launch ‡∏à‡∏∞‡∏õ‡∏¥‡∏î node ‡∏•‡∏π‡∏Å‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÉ‡∏´‡πâ‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥
ros2 launch "$LAUNCH_FILE"

# Script ‡∏à‡∏∞‡∏£‡∏≠‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà‡∏à‡∏ô‡∏Å‡∏ß‡πà‡∏≤ ros2 launch ‡∏à‡∏∞‡∏à‡∏ö (Ctrl+C ‡∏´‡∏£‡∏∑‡∏≠ error)
echo -e "${GREEN}‚úÖ Robot System ‡∏´‡∏¢‡∏∏‡∏î‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢${NC}"
