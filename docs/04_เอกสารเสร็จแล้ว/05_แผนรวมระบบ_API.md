# แผนการรวม API: การนำตรรกะ Avatar มารวมกับ Chat API

## เป้าหมาย
รวมฟีเจอร์ที่มีประโยชน์แต่ยังไม่ได้ถูกใช้งานจาก `avatar_api.py` เข้ามาไว้ใน `chat_api.py` (ซึ่งเป็นตัวหลักที่ใช้งานอยู่) เพื่อสร้าง WebSocket Endpoint เดียวที่สมบูรณ์สำหรับ Avatar การรวมนี้จะช่วยกู้คืนฟีเจอร์ "โหมดว่าง (Idle Mode)", การจัดการอารมณ์ (Mood) ที่สม่ำเสมอ และลดความซ้ำซ้อนของโค้ด

## สิ่งที่ต้องให้ผู้ใช้ช่วยตรวจสอบ
> [!IMPORTANT]
> **จุดตัดสินใจ: การสตรีมเสียง (Audio Streaming)**
> * `avatar_api.py` สตรีมข้อมูลเสียงแบบ Byte โดยตรงผ่าน WebSocket
> * `chat_api.py` ส่งข้อมูลแบบ JSON แล้วให้ Frontend (หน้าบ้าน) ไปเรียก TTS ผ่าน REST API
> * **คำแนะนำ**: ใช้แบบ JSON ของ `chat_api` ต่อไป (ง่ายกว่า และทำงานได้ดีกับ `app.js` ปัจจุบัน) แต่ถ้าต้องการความไวสูง (Low Latency) เราค่อยปรับไปใช้แบบสตรีมทีหลังได้
> * *แผนปัจจุบันจะสมมติว่าเราคงวิธีส่ง JSON ไว้ แต่เพิ่มฟีเจอร์ "Idel" และ "Mode" เข้ามา*

## รายละเอียดการแก้ไข

### Backend: `Back-end/api/routers/chat_api.py`
#### [MODIFY] ฟังก์ชัน `websocket_endpoint`
- **เพิ่มตัวจัดการ Idle Prompt (ชวนคุยเมื่อเงียบ)**:
  - ย้ายตรรกะ `_handle_idle_prompt` มาใส่
  - ดักจับ `action: "idle_prompt"` จาก JSON ที่ส่งเข้ามา
  - ส่งประโยคชวนคุยสุ่มกลับไป พร้อมกำหนด `avatar_mood="talking"`
- **เพิ่มการสลับโหมด (Mode Switching)**:
  - ย้ายตัวจัดการ `SET_MODE` มาใส่
  - อัปเดตตัวแปร `ai_mode` ในลูป หรือใน Session Manager
- **ปรับปรุงตรรกะอารมณ์ (Mood Logic)**:
  - เพิ่มตรรกะ "เพลง = กำลังฟัง": ถ้า action เป็น `MUSIC` ให้ตั้ง `avatar_mood` เป็น `listening` (ใส่หูฟัง) โดยไม่สนว่า AI จะตอบอะไรมา
  - เพิ่มตรรกะ "รูปภาพ = มีความสุข": ถ้ามีรูปภาพ ให้ตั้ง `avatar_mood` เป็น `happy`

### Backend: `Back-end/api/routers/avatar_api.py`
#### [DELETE]
- ลบไฟล์นี้ หรือเปลี่ยนชื่อเป็นไฟล์เก่าหลังจากการรวมเสร็จสิ้น เพื่อไม่ให้สับสน

## แผนการตรวจสอบ (Verification)

### การทดสอบด้วยตนเอง (Manual Verification)
1.  **ทดสอบ Idle Mode**:
    - เปิดหน้าเว็บทิ้งไว้ รอจน Timeout และดูว่า Avatar พูดทักทายขึ้นมาไหม "มีอะไรให้ช่วยอีกไหมคะ?" (Trigger โดย Frontend ส่ง `idle_prompt` มา)
2.  **ทดสอบการเปลี่ยนโหมด**:
    - กดปุ่มสลับ "Fast/Detailed" ที่หน้าบ้าน และดู Log หลังบ้านว่าขึ้น "Switched to ... mode" หรือไม่
3.  **ทดสอบอารมณ์เพลง**:
    - พิมพ์ "เปิดเพลง" แล้วดูว่า Avatar เปลี่ยนหน้าเป็น "Listening" (ใส่หูฟัง) หรือไม่
4.  **ทดสอบแชทปกติ**:
    - ตรวจสอบว่าแชทปกติยังคุยได้รู้เรื่อง และ Avatar แสดงอารมณ์ตามที่ AI ส่งมา (เช่น [MOOD: happy]) ได้ถูกต้อง
