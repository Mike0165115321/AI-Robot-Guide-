# р╕гр╕░р╕Ър╕Ър╕Др╕┤р╕зр╣Бр╕ер╕░р╕Бр╕▓р╕гр╣Бр╕Бр╣Йр╕Ыр╕▒р╕Нр╕лр╕▓ Blocking I/O (Queue & Blocking I/O Guide)

р╣Ар╕нр╕Бр╕кр╕▓р╕гр╕Щр╕╡р╣Йр╕гр╕зр╕Ър╕гр╕зр╕бр╣Бр╕Щр╕зр╕Чр╕▓р╕Зр╕Бр╕▓р╕гр╕нр╕нр╕Бр╣Бр╕Ър╕Ър╕гр╕░р╕Ър╕Ър╕Др╕┤р╕з (Queue) р╕Фр╣Йр╕зр╕в Redis р╣Бр╕ер╕░р╕зр╕┤р╣Ар╕Др╕гр╕▓р╕░р╕лр╣Мр╕Ыр╕▒р╕Нр╕лр╕▓ "р╕Др╕нр╕Вр╕зр╕Ф" р╕Чр╕╡р╣Ир╣Ар╕Бр╕┤р╕Фр╕Ир╕▓р╕Бр╕Бр╕▓р╕гр╣Ар╕гр╕╡р╕вр╕Б Database р╣Бр╕Ър╕Ър╕Ьр╕┤р╕Фр╕зр╕┤р╕Шр╕╡р╣Гр╕Щ FastAPI р╕Юр╕гр╣Йр╕нр╕бр╕зр╕┤р╕Шр╕╡р╣Бр╕Бр╣Йр╣Др╕В р╣Ар╕Юр╕╖р╣Ир╕нр╣Гр╕лр╣Йр╕Щр╕│р╣Др╕Ыр╕Ыр╕гр╕▒р╕Ър╣Гр╕Кр╣Йр╣Гр╕Щр╣Вр╕Ыр╕гр╣Ар╕Ир╕Бр╕Хр╣Мр╕нр╕╖р╣Ир╕Щр╣Др╕Фр╣Й

---

## 1. р╕Ьр╕▒р╕Зр╕Бр╕▓р╕гр╕Чр╕│р╕Зр╕▓р╕Щр╕Вр╕нр╕Зр╕гр╕░р╕Ър╕Ър╕Др╕┤р╕з (Queue Architecture)

р╣Ар╕гр╕▓р╣Гр╕Кр╣Йр╣Вр╕бр╣Ар╕Фр╕е **Producer-Consumer** р╣Ар╕Юр╕╖р╣Ир╕нр╣Бр╕вр╕Бр╕Бр╕▓р╕гр╕гр╕▒р╕Ъ Request (р╕Чр╕╡р╣Ир╕Хр╣Йр╕нр╕Зр╣Ар╕гр╣Зр╕з) р╕нр╕нр╕Бр╕Ир╕▓р╕Бр╕Бр╕▓р╕гр╕Ыр╕гр╕░р╕бр╕зр╕ер╕Ьр╕ер╕лр╕Щр╕▒р╕Бр╣Ж (AI/Database)

```mermaid
sequenceDiagram
    participant User
    participant Webhook (FastAPI)
    participant Redis (Queue)
    participant Worker (Background)
    
    User->>Webhook: р╕кр╣Ир╕Зр╕Вр╣Йр╕нр╕Др╕зр╕▓р╕б (LINE Message)
    Webhook->>Webhook: р╕Хр╕гр╕зр╕Ир╕кр╕нр╕Ъ Signature
    Webhook->>Redis: 1. р╣Вр╕вр╕Щр╕Зр╕▓р╕Щр╣Ар╕Вр╣Йр╕▓р╕Др╕┤р╕з (lpush) тЪбя╕П р╣Ар╕гр╣Зр╕зр╕бр╕▓р╕Б
    Webhook-->>User: р╕Хр╕нр╕Ър╕Бр╕ер╕▒р╕Ъ "OK" (200) р╕Чр╕▒р╕Щр╕Чр╕╡
    
    loop Background Process
        Worker->>Redis: 2. р╕гр╕нр╕гр╕▒р╕Ър╕Зр╕▓р╕Щ (brpop)
        Redis-->>Worker: р╣Др╕Фр╣Йр╕Зр╕▓р╕Щ (JSON)
        Worker->>Worker: 3. р╕Ыр╕гр╕░р╕бр╕зр╕ер╕Ьр╕е (AI / DB) ЁЯРв р╕Кр╣Йр╕▓р╣Др╕Фр╣Йр╕Хр╕▓р╕бр╕кр╕Ър╕▓р╕в
        Worker->>User: 4. р╕кр╣Ир╕Зр╕Вр╣Йр╕нр╕Др╕зр╕▓р╕бр╕Хр╕нр╕Ър╕Бр╕ер╕▒р╕Ъ (Push Message)
    end
```

### р╕Вр╣Йр╕нр╕Фр╕╡р╕Вр╕нр╕Зр╕гр╕░р╕Ър╕Ър╕Щр╕╡р╣Й
*   **High Availability**: Webhook р╣Др╕бр╣Ир╕ер╣Ир╕бр╕Зр╣Ир╕▓р╕вр╣Ж р╣Ар╕Юр╕гр╕▓р╕░р╣Др╕бр╣Ир╕Хр╣Йр╕нр╕Зр╕гр╕н AI р╕Др╕┤р╕Фр╣Гр╕лр╣Йр╣Ар╕кр╕гр╣Зр╕И
*   **Scalability**: р╕Цр╣Йр╕▓р╕Зр╕▓р╕Щр╕ер╣Йр╕Щр╕Др╕┤р╕з р╕кр╕▓р╕бр╕▓р╕гр╕Цр╣Ар╕Юр╕┤р╣Ир╕б Worker (р╕гр╕▒р╕Щ `worker.py` р╕лр╕ер╕▓р╕вр╣Ж р╕Хр╕▒р╕з) р╕бр╕▓р╕Кр╣Ир╕зр╕вр╕Бр╕▒р╕Щр╕гр╕╕р╕бр╕Чр╕│р╕Зр╕▓р╕Щр╣Др╕Фр╣Йр╕Чр╕▒р╕Щр╕Чр╕╡

---

## 2. р╣Вр╕Др╣Йр╕Фр╕кр╣Ир╕зр╕Щ Webhook (Producer) р╣Бр╕ер╕░р╕Ыр╕▒р╕Нр╕лр╕▓ Blocking I/O

р╕Щр╕╡р╣Ир╕Др╕╖р╕нр╕кр╣Ир╕зр╕Щр╕Чр╕╡р╣Ир╕бр╕╡р╕Ыр╕▒р╕Нр╕лр╕▓р╣Гр╕Щр╣Вр╕Ыр╕гр╣Ар╕Ир╕Бр╕Хр╣Мр╕Ыр╕▒р╕Ир╕Ир╕╕р╕Ър╕▒р╕Щ р╣Бр╕ер╕░р╣Ар╕Ыр╣Зр╕Щ **Case Study** р╕Чр╕╡р╣Ир╕Фр╕╡р╕кр╕│р╕лр╕гр╕▒р╕Ър╕Бр╕▓р╕гр╕Чр╕│ Web Service

### тЭМ р╕Ыр╕▒р╕Нр╕лр╕▓: р╕Бр╕▓р╕гр╣Ар╕гр╕╡р╕вр╕Б Sync DB р╣Гр╕Щ Async Function

р╣Гр╕Щ **FastAPI**, р╕Цр╣Йр╕▓р╕Др╕╕р╕Ур╕Ыр╕гр╕░р╕Бр╕▓р╕ир╕Яр╕▒р╕Зр╕Бр╣Мр╕Кр╕▒р╕Щр╣Ар╕Ыр╣Зр╕Щ `async def`, Python р╕Ир╕░р╕гр╕▒р╕Щр╣Вр╕Др╣Йр╕Фр╕Щр╕▒р╣Йр╕Щр╣Гр╕Щ **Event Loop** р╣Ар╕Фр╕╡р╕вр╕зр╕Бр╕▒р╕Щр╕Чр╕▒р╣Йр╕Зр╕лр╕бр╕Ф
*   **р╕Бр╕Ор╣Ар╕лр╕ер╣Зр╕Б**: р╕лр╣Йр╕▓р╕бр╕бр╕╡р╣Вр╕Др╣Йр╕Фр╕Чр╕╡р╣И "р╕гр╕н" (Blocking) р╕Щр╕▓р╕Щр╣Ж р╣Гр╕Щ `async def` р╣Вр╕Фр╕вр╣Др╕бр╣Ир╕бр╕╡ `await`
*   **р╕Др╕зр╕▓р╕бр╕Ьр╕┤р╕Фр╕Юр╕ер╕▓р╕Ф**: р╕Бр╕▓р╕гр╣Ар╕гр╕╡р╕вр╕Б `sqlite3` р╕лр╕гр╕╖р╕н Database Driver р╕Чр╕▒р╣Ир╕зр╣Др╕Ыр╕Чр╕╡р╣Ир╣Ар╕Ыр╣Зр╕Щ Synchronous (р╕гр╕н I/O р╕Щр╕▓р╕Щ)

```python
# р╕Хр╕▒р╕зр╕нр╕вр╣Ир╕▓р╕Зр╣Вр╕Др╣Йр╕Фр╕Чр╕╡р╣Ир╕бр╕╡р╕Ыр╕▒р╕Нр╕лр╕▓ (Anti-Pattern)
@app.post("/webhook")
async def handle_webhook(request: Request): # 1. р╕Ыр╕гр╕░р╕Бр╕▓р╕ир╣Ар╕Ыр╣Зр╕Щ Async
    # ... р╕гр╕▒р╕Ъ Request ...

    # 2. тЭМ р╣Ар╕гр╕╡р╕вр╕Б Database р╣Бр╕Ър╕Ъ Sync (Blocking) р╕Хр╕гр╕Зр╣Ж
    # р╕Ир╕▒р╕Зр╕лр╕зр╕░р╕Щр╕╡р╣Й Event Loop р╕Ир╕░ "р╕лр╕вр╕╕р╕Фр╕Щр╕┤р╣Ир╕З" (Freeze) 
    # Request р╕Вр╕нр╕Зр╕Др╕Щр╕нр╕╖р╣Ир╕Щр╕Чр╕╡р╣Ир╣Ар╕Вр╣Йр╕▓р╕бр╕▓р╕Кр╣Ир╕зр╕Зр╕Щр╕╡р╣Йр╕Ир╕░ "р╕Др╣Йр╕▓р╕З" р╕Ир╕Щр╕Бр╕зр╣Ир╕▓р╕Ър╕гр╕гр╕Чр╕▒р╕Фр╕Щр╕╡р╣Йр╕Ир╕░р╣Ар╕кр╕гр╣Зр╕И
    user_persona = get_user_persona(user_id) 
    
    # 3. р╣Вр╕вр╕Щр╕Зр╕▓р╕Щр╣Ар╕Вр╣Йр╕▓ Redis
    redis_client.lpush(QUEUE_KEY, json.dumps(job))
```

### тЬЕ р╕зр╕┤р╕Шр╕╡р╣Бр╕Бр╣Йр╣Др╕В: р╣Гр╕Кр╣Й `run_in_threadpool`

р╕зр╕┤р╕Шр╕╡р╣Бр╕Бр╣Йр╕Чр╕╡р╣Ир╕Зр╣Ир╕▓р╕вр╕Чр╕╡р╣Ир╕кр╕╕р╕Фр╣Вр╕Фр╕вр╣Др╕бр╣Ир╕Хр╣Йр╕нр╕Зр╕гр╕╖р╣Йр╕н Database Driver р╣Гр╕лр╕бр╣Ир╕Др╕╖р╕нр╕Бр╕▓р╕гр╕кр╕▒р╣Ир╕Зр╣Гр╕лр╣Й FastAPI р╣Ар╕нр╕▓р╣Вр╕Др╣Йр╕Фр╕кр╣Ир╕зр╕Щр╕Чр╕╡р╣Ир╕Кр╣Йр╕▓р╣Ж р╣Др╕Ыр╕гр╕▒р╕Щр╣Гр╕Щ **Thread** р╣Бр╕вр╕Бр╕Хр╣Ир╕▓р╕Зр╕лр╕▓р╕Б р╣Ар╕Юр╕╖р╣Ир╕нр╣Др╕бр╣Ир╣Гр╕лр╣Йр╕Вр╕зр╕▓р╕З Event Loop р╕лр╕ер╕▒р╕Б

```python
from fastapi.concurrency import run_in_threadpool # 1. import р╕Хр╕▒р╕зр╕Кр╣Ир╕зр╕в

@app.post("/webhook")
async def handle_webhook(request: Request):
    # ...
    
    # 2. тЬЕ р╣Ар╕гр╕╡р╕вр╕Бр╣Гр╕Кр╣Йр╕Ьр╣Ир╕▓р╕Щ run_in_threadpool р╕Юр╕гр╣Йр╕нр╕б await
    # FastAPI р╕Ир╕░р╣Вр╕вр╕Щ function р╕Щр╕╡р╣Йр╣Др╕Ыр╕гр╕▒р╕Щр╣Гр╕Щ Thread р╕нр╕╖р╣Ир╕Щ р╣Бр╕ер╣Йр╕зр╕Др╣Ир╕нр╕вр╕Бр╕ер╕▒р╕Ър╕бр╕▓р╣Ар╕бр╕╖р╣Ир╕нр╣Ар╕кр╕гр╣Зр╕И
    user_persona = await run_in_threadpool(get_user_persona, user_id)
    
    # ...
```

---

## 3. р╣Вр╕Др╣Йр╕Фр╕кр╣Ир╕зр╕Щ Worker (Consumer)

р╕кр╣Ир╕зр╕Щ Worker р╣Др╕бр╣Ир╕бр╕╡р╕Ыр╕▒р╕Нр╕лр╕▓р╣Ар╕гр╕╖р╣Ир╕нр╕З Blocking р╕гр╕╕р╕Щр╣Бр╕гр╕Зр╣Ар╕Чр╣Ир╕▓ Webhook р╣Ар╕Юр╕гр╕▓р╕░р╕бр╕▒р╕Щр╕гр╕▒р╕Щр╣Бр╕вр╕Б Process р╕Бр╕▒р╕Щ р╣Бр╕Хр╣Ир╕бр╕╡р╕Ир╕╕р╕Фр╕Чр╕╡р╣Ир╕Хр╣Йр╕нр╕Зр╕гр╕░р╕зр╕▒р╕Зр╣Гр╕Щр╕Бр╕▓р╕гр╕Фр╕╢р╕Зр╕Зр╕▓р╕Щ

```python
import redis
import json

def main():
    # р╣Ар╕Кр╕╖р╣Ир╕нр╕бр╕Хр╣Ир╕н Redis
    r = redis.Redis(host='localhost', port=6379, db=0)
    
    while True:
        # 1. тЪая╕П р╣Гр╕Кр╣Й brpop р╣Бр╕Чр╕Щ pop р╕Шр╕гр╕гр╕бр╕Фр╕▓
        # brpop (Blocking Pop) р╕Ир╕░ "р╕гр╕н" р╕нр╕вр╕╣р╣Ир╕Хр╕гр╕Зр╕Щр╕╡р╣Йр╕Ир╕Щр╕Бр╕зр╣Ир╕▓р╕Ир╕░р╕бр╕╡р╕Вр╕нр╕Зр╕бр╕▓
        # р╕Чр╕│р╣Гр╕лр╣Йр╣Др╕бр╣Ир╣Ар╕Ыр╕ер╕╖р╕нр╕З CPU р╕зр╕Щр╕ер╕╣р╕Ыр╣Ар╕Кр╣Зр╕Др╕Вр╕нр╕Зр╣Ар╕Ыр╕ер╣Ир╕▓р╣Ж (Busy Waiting)
        # timeout=0 р╕Др╕╖р╕нр╕гр╕нр╕Хр╕ер╕нр╕Фр╣Др╕Ы
        queue_name, data_json = r.brpop("my_queue_key", timeout=0)
        
        # 2. р╣Бр╕Ыр╕ер╕Зр╕Вр╣Йр╕нр╕бр╕╣р╕ер╣Бр╕ер╕░р╕Чр╕│р╕Зр╕▓р╕Щ
        data = json.loads(data_json)
        process_task(data)
```

## р╕кр╕гр╕╕р╕Ыр╕кр╕│р╕лр╕гр╕▒р╕Ър╕Бр╕▓р╕гр╕Щр╕│р╣Др╕Ыр╣Гр╕Кр╣Йр╕Хр╣Ир╕н

1. р╣Гр╕Кр╣Йр╕нр╕▓р╕гр╣Мр╕Бр╕┤р╣Ар╕Чр╕Бр╣Ар╕Ир╕нр╕гр╣М **Producer (FastAPI) -> Redis -> Consumer (Worker)** р╣Ар╕кр╕бр╕нр╕кр╕│р╕лр╕гр╕▒р╕Ър╕Зр╕▓р╕Щр╕Чр╕╡р╣Ир╣Гр╕Кр╣Йр╣Ар╕зр╕ер╕▓р╣Ар╕Бр╕┤р╕Щ 1-2 р╕зр╕┤р╕Щр╕▓р╕Чр╕╡ (р╣Ар╕Кр╣Ир╕Щ AI, Image Processing)
2. р╣Гр╕Щ **FastAPI (`async def`)**, р╕лр╣Йр╕▓р╕бр╣Ар╕гр╕╡р╕вр╕Б Database р╕лр╕гр╕╖р╕н I/O р╣Бр╕Ър╕Ъ Sync р╕Хр╕гр╕Зр╣Ж
    *   р╕Цр╣Йр╕▓р╣Ар╕ер╕╡р╣Ир╕вр╕Зр╣Др╕бр╣Ир╣Др╕Фр╣Й р╣Гр╕лр╣Йр╣Гр╕Кр╣Й `await run_in_threadpool(func, args)`
    *   р╕лр╕гр╕╖р╕нр╣Ар╕Ыр╕ер╕╡р╣Ир╕вр╕Щр╣Др╕Ыр╣Гр╕Кр╣Й Library р╣Бр╕Ър╕Ъ Async (р╣Ар╕Кр╣Ир╕Щ `motor` р╕кр╕│р╕лр╕гр╕▒р╕Ъ MongoDB, `aiosqlite` р╕кр╕│р╕лр╕гр╕▒р╕Ъ SQLite)
3. р╣Гр╕Кр╣Й `brpop` р╣Гр╕Щ Worker р╣Ар╕Юр╕╖р╣Ир╕нр╕Ыр╕гр╕░р╕лр╕вр╕▒р╕Ф CPU
